<!-- public/admin.html -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - Baby Cutie</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="logo">
            <img src="images/logo2.jpg" alt="Baby Cutie Logo"> 
            <span>Baby Cutie</span> 
        </div>
</nav>
<div class="container" style="padding-top:80px;">
  <h3>Quản lý danh mục</h3>
  <form id="catForm" class="row g-2 mb-3">
    <input type="hidden" id="catId" value="">
    <div class="col-md-4">
      <input class="form-control" id="catName" placeholder="Tên danh mục" required>
    </div>
    <div class="col-md-6">
      <input class="form-control" id="catDesc" placeholder="Mô tả">
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" id="catSave">Lưu</button>
    </div>
  </form>
  <table class="table table-striped" id="catTable"></table>

  <hr>
  <h3>Quản lý sản phẩm</h3>
  <form id="prodForm" class="row g-2 mb-3" enctype="multipart/form-data">
    <input type="hidden" id="prodId" value="">
    <div class="col-md-3">
      <input class="form-control" id="prodName" placeholder="Tên sản phẩm" required>
    </div>
    <div class="col-md-2">
      <select id="prodCategory" class="form-select"></select>
    </div>
    <div class="col-md-2">
      <input class="form-control" id="prodPrice" placeholder="Giá" type="number" required>
    </div>
    <div class="col-md-2">
      <input class="form-control" id="prodProtein" placeholder="Protein">
    </div>
    <div class="col-md-2">
      <input class="form-control" id="prodCarb" placeholder="Carb">
    </div>
    <div class="col-md-12">
      <textarea id="prodDesc" class="form-control" rows="2" placeholder="Mô tả"></textarea>
    </div>
    <div class="col-md-4 mt-2">
      <input type="file" id="prodImage" accept="image/*" class="form-control">
    </div>
    <div class="col-md-2 mt-2">
      <button class="btn btn-success w-100" id="prodSave">Lưu sản phẩm</button>
    </div>
  </form>
  <table class="table admin-table" id="prodTable"></table>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/api.js"></script>
<script>
async function loadCats() {
  const cats = await apiGet('/categories');
  $('#catTable').html(`<tr><th>#</th><th>Tên</th><th>Mô tả</th><th>Hành động</th></tr>`);
  cats.forEach(c => {
    $('#catTable').append(`<tr>
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.description||''}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editCat(${c.id},'${escape(c.name)}','${escape(c.description||'')}')">Sửa</button>
        <button class="btn btn-sm btn-danger" onclick="delCat(${c.id})">Xóa</button>
      </td>
    </tr>`);
  });
  $('#prodCategory').empty();
  $('#prodCategory').append('<option value="">--Chọn danh mục--</option>');
  cats.forEach(c => $('#prodCategory').append(`<option value="${c.id}">${c.name}</option>`));
}

function editCat(id, nameEsc, descEsc) {
  $('#catId').val(id);
  $('#catName').val(unescape(nameEsc));
  $('#catDesc').val(unescape(descEsc));
}
async function delCat(id) {
  if (!confirm('Xác nhận xóa danh mục?')) return;
  await apiDelete(`/categories/${id}`);
  loadCats();
}

$('#catForm').on('submit', async function(e){
  e.preventDefault();
  const id = $('#catId').val();
  const data = { name: $('#catName').val(), description: $('#catDesc').val() };
  if (id) {
    await apiPut(`/categories/${id}`, data);
  } else {
    await apiPost('/categories', data);
  }
  $('#catForm')[0].reset();
  $('#catId').val('');
  loadCats();
});

/* Products */
async function loadProds() {
  const prods = await apiGet('/products');
  $('#prodTable').html(`<tr><th>#</th><th>Ảnh</th><th>Tên</th><th>Giá</th><th>Danh mục</th><th>TT dinh dưỡng</th><th>Hành động</th></tr>`);
  prods.forEach(p => {
    const img = p.image ? '/uploads/' + p.image : 'images/default.gif';
    $('#prodTable').append(`<tr>
      <td>${p.id}</td>
      <td><img src="${img}" alt="${p.name}"></td>
      <td>${p.name}</td>
      <td>${p.price}đ</td>
      <td>${p.categoryName||''}</td>
      <td>${p.protein}g / ${p.carb}g / ${p.fat}g</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="editProd(${p.id})">Sửa</button>
        <button class="btn btn-sm btn-danger" onclick="delProd(${p.id})">Xóa</button>
      </td>
    </tr>`);
  });
}

async function editProd(id) {
  const p = await apiGet(`/products/${id}`);
  $('#prodId').val(p.id);
  $('#prodName').val(p.name);
  $('#prodDesc').val(p.description);
  $('#prodPrice').val(p.price);
  $('#prodProtein').val(p.protein);
  $('#prodCarb').val(p.carb);
  $('#prodCategory').val(p.category_id);
}

async function delProd(id) {
  if (!confirm('Xác nhận xóa sản phẩm?')) return;
  await apiDelete(`/products/${id}`);
  loadProds();
}

$('#prodForm').on('submit', async function(e){
  e.preventDefault();
  const id = $('#prodId').val();
  const form = new FormData();
  form.append('name', $('#prodName').val());
  form.append('description', $('#prodDesc').val());
  form.append('price', $('#prodPrice').val());
  form.append('category_id', $('#prodCategory').val());
  form.append('protein', $('#prodProtein').val());
  form.append('carb', $('#prodCarb').val());
  const file = $('#prodImage')[0].files[0];
  if (file) form.append('image', file);

  try {
    if (id) {
      await apiPut(`/products/${id}`, form, true);
    } else {
      await apiPost('/products', form, true);
    }
    $('#prodForm')[0].reset();
    $('#prodId').val('');
    loadProds();
  } catch(err) {
    alert('Có lỗi. Kiểm tra console.');
    console.error(err);
  }
});

$(function(){ loadCats(); loadProds(); });
</script>
</body>
</html>
